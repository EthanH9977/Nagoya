<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹æˆ°åœ‹æ—…è¨˜ Nagoya Sengoku</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <!-- å¼•å…¥æ—¥å¼æ¯›ç­†å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">

    <style>
        /* --- æˆ°åœ‹é¢¨é…è‰² --- */
        :root {
            --jp-kachi: #181B39;   /* å‹è‰² */
            --jp-gold: #C5A059;    /* é‡‘æ³¥ */
            --jp-akane: #9E2A2B;   /* èŒœè‰² */
            --jp-paper: #F4F1EA;   /* å’Œç´™ç™½ */
            --jp-ink: #2F2F2F;     /* å¢¨è‰² */
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Heiti TC", "Noto Sans TC", sans-serif;
            background-color: var(--jp-kachi);
            color: var(--jp-paper);
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 10a10 10 0 0 1 20 0 10 10 0 0 1-20 0zm10-5a5 5 0 0 1 5 5 5 5 0 0 1-10 0z' fill='%231e2245' fill-opacity='0.4'/%3E%3C/svg%3E");
        }

        .font-sengoku { font-family: 'Yuji Syuku', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        .hero-bg {
            background: linear-gradient(to bottom, rgba(24, 27, 57, 0.7), rgba(24, 27, 57, 1)), url('https://images.unsplash.com/photo-1606320563467-15a08835805c?q=80&w=2072&auto=format&fit=crop');
            background-size: cover;
            background-position: center 30%;
            border-bottom: 4px solid var(--jp-gold);
        }

        .kamon-bg {
            position: absolute; top: -20px; right: -20px; width: 150px; height: 150px; opacity: 0.1;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/6/6c/Oda_clan_mon.svg/1024px-Oda_clan_mon.svg.png');
            background-size: contain; background-repeat: no-repeat; transform: rotate(15deg);
        }

        .timeline-line {
            position: absolute; left: 58px; top: 14px; bottom: -20px; width: 2px;
            background-color: var(--jp-gold); opacity: 0.3; z-index: 0;
        }

        .sengoku-card {
            background-color: var(--jp-paper); color: var(--jp-ink);
            border-left: 4px solid var(--jp-gold); box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
        }

        .tag-wood {
            background-color: #3E362E; color: #D4C5B0; padding: 2px 6px; border-radius: 2px;
            font-family: 'Yuji Syuku', serif; font-size: 0.7rem; letter-spacing: 0.1em;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-[#181B39] z-[100] flex flex-col justify-center items-center transition-opacity duration-1000">
        <div class="kamon-bg" style="opacity: 0.05; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 300px;"></div>
        <div class="flex flex-row-reverse items-center gap-4 border-r-2 border-[#C5A059] pr-6 h-48">
            <h1 class="font-sengoku text-[#C5A059] text-5xl writing-vertical tracking-widest">åå¤å±‹</h1>
            <h2 class="font-sengoku text-white text-2xl writing-vertical tracking-[0.5em] opacity-80">å‡ºé™£æº–å‚™ä¸­</h2>
        </div>
        <div class="mt-8 animate-pulse text-[#C5A059]"><i class="fas fa-circle-notch fa-spin text-xl"></i></div>
    </div>

    <!-- Header -->
    <header class="hero-bg text-white p-6 sticky top-0 z-40 shadow-lg relative overflow-hidden">
        <div class="kamon-bg"></div>
        <div class="max-w-md mx-auto relative z-10">
            <div class="flex justify-between items-end">
                <div>
                    <div class="text-xs text-[#C5A059] tracking-[0.2em] mb-1 font-sengoku" id="current-date">LOADING...</div>
                    <h1 class="text-4xl mb-2 font-sengoku tracking-wide" id="current-location">å°¾å¼µåœ‹</h1>
                    <!-- å¤©æ°£å€å¡Šï¼šå¢åŠ  id="weather-box" ç”¨æ–¼æ›´æ–° -->
                    <div id="weather-box" class="flex items-center text-xs font-medium bg-black/40 inline-block px-3 py-1 border border-[#C5A059]/50">
                        <i class="fas fa-cloud-moon mr-2 text-[#C5A059]" id="weather-icon"></i>
                        <span id="weather-temp">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
                <div class="text-center">
                    <div class="border-2 border-[#C5A059] w-16 h-16 flex flex-col items-center justify-center bg-[#181B39]">
                        <span class="text-[10px] text-[#C5A059] block -mb-1">DAY</span>
                        <span class="text-3xl font-sengoku text-white" id="day-display">-</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pt-8 pb-48 max-w-md relative z-10">
        <div id="timeline-container" class="space-y-1">
            <!-- å¡ç‰‡å€ -->
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-[#11132B]/95 backdrop-blur border-t border-[#C5A059]/30 pb-safe z-50">
        <div class="max-w-md mx-auto">
            <div class="flex justify-center py-4 space-x-6" id="day-scroller">
                <!-- JS ç”ŸæˆæŒ‰éˆ• -->
            </div>
            <div class="grid grid-cols-2 gap-1 py-2 text-[10px] text-[#C5A059]/70 border-t border-[#C5A059]/10 bg-[#0D0F22]">
                <button onclick="location.reload()" class="flex flex-col items-center justify-center py-1 hover:text-[#C5A059]">
                    <i class="fas fa-sync-alt text-base mb-1"></i>
                    <span class="tracking-widest font-sengoku">æˆ°æ³æ›´æ–°</span>
                </button>
                <button onclick="window.open('https://www.google.com/maps/d/u/0/', '_blank')" class="flex flex-col items-center justify-center py-1 hover:text-[#C5A059]">
                    <i class="fas fa-map-marked-alt text-base mb-1"></i>
                    <span class="tracking-widest font-sengoku">è»äº‹åœ°åœ–</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Modal -->
    <div id="info-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center p-5 backdrop-blur-sm" onclick="closeModal()">
        <div class="bg-[#F4F1EA] w-full max-w-sm shadow-[0_0_30px_rgba(197,160,89,0.3)] overflow-hidden relative animate-[fadeInUp_0.3s_ease-out] border-y-8 border-[#181B39]" onclick="event.stopPropagation()">
            <div class="p-6 text-[#2F2F2F]">
                <button onclick="closeModal()" class="absolute top-2 right-2 text-[#9E2A2B] w-8 h-8 flex items-center justify-center hover:bg-[#9E2A2B]/10 rounded-full">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 class="text-2xl font-sengoku text-[#181B39] mb-4 border-b-2 border-[#C5A059]/30 pb-2" id="modal-title">...</h3>
                <div class="space-y-4 text-sm leading-relaxed font-medium">
                    <p id="modal-desc" class="text-base">...</p>
                    <div id="modal-tip-box" class="bg-[#E8E4D9] p-4 relative mt-6 border-l-4 border-[#9E2A2B]">
                        <span class="absolute -top-3 left-2 bg-[#9E2A2B] text-[#F4F1EA] px-2 text-xs font-sengoku tracking-widest py-0.5">è»å¸«å»ºè¨€</span>
                        <p id="modal-tip" class="mt-1 text-[#5A4A3A]">...</p>
                    </div>
                    <button id="modal-action-btn" class="w-full mt-6 bg-[#181B39] text-[#C5A059] py-4 shadow hover:bg-[#252954] transition active:scale-[0.98] flex items-center justify-center gap-3 font-bold text-base tracking-widest border border-[#C5A059]">
                        <i class="fas fa-location-arrow"></i> 
                        <span>å‡ºé™£ (Google Maps)</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMGw2d4YIMt5c3cr33kCZJw1kYia6Gp-OuM-_SK79FYBe5y1JVJTWi5ZNEW5RrjAD_A1pS3fMgwbVI/pub?output=csv';
        
        const iconMap = {
            'transport': 'fa-train',
            'spot': 'fa-camera',
            'must-go': 'fa-dragon',
            'food': 'fa-bowl-rice',
            'hotel': 'fa-bed',
            'fun': 'fa-fan'
        };

        // ğŸ“ åœ°é»åº§æ¨™å°ç…§è¡¨ (ç”¨æ–¼æ°£è±¡æŸ¥è©¢)
        const cityCoordinates = {
            "åå¤å±‹ Nagoya": { lat: 35.1815, lon: 136.9066 }, // åå¤å±‹å¸‚
            "æ¦® & å¤§é ˆ": { lat: 35.1691, lon: 136.9020 },      // æ¦® (å¸‚ä¸­å¿ƒ)
            "å››é–“é“ & å¸¸æ»‘": { lat: 34.8893, lon: 136.8338 }, // å¸¸æ»‘ (æ¯”è¼ƒå—é‚Š)
            // é è¨­å€¼ (åå¤å±‹)
            "default": { lat: 35.1815, lon: 136.9066 }
        };

        let globalItinerary = [];

        document.addEventListener('DOMContentLoaded', () => {
            Papa.parse(SHEET_CSV_URL, {
                download: true,
                header: true,
                complete: function(results) { processData(results.data); },
                error: function(err) { 
                    console.error(err); 
                    document.getElementById('loading-screen').style.display = 'none';
                }
            });
        });

        function processData(rawData) {
            const groupedData = {};
            rawData.forEach(row => {
                if(!row.Day) return;
                const day = row.Day;
                if(!groupedData[day]) groupedData[day] = { day: day, date: row.Date, location: row.Location, weather: row.Weather, events: [] };
                groupedData[day].events.push({
                    time: row.Time, title: row.Title, type: row.Type,
                    icon: iconMap[row.Type] || 'fa-circle',
                    desc: row.Description, tip: row.Tips, location: row.MapQuery
                });
            });
            
            globalItinerary = Object.values(groupedData).sort((a, b) => parseInt(a.day) - parseInt(b.day));
            renderDayScroller();
            loadDay(globalItinerary[0]?.day || 1);
            
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('opacity-0');
                setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 1000);
            }, 1500);
        }

        function renderDayScroller() {
            const scroller = document.getElementById('day-scroller');
            scroller.innerHTML = globalItinerary.map(d => `
                <button onclick="loadDay('${d.day}')" id="day-btn-${d.day}" 
                    class="w-12 h-12 flex flex-col items-center justify-center border-2 border-[#C5A059]/30 bg-[#0D0F22] text-[#C5A059]/50 transition-all duration-300 transform hover:scale-110 rotate-45 group overflow-hidden">
                    <div class="-rotate-45 flex flex-col items-center">
                        <span class="text-[10px] font-bold">DAY</span>
                        <span class="text-lg font-sengoku leading-none">${d.day}</span>
                    </div>
                </button>
            `).join('');
        }

        // ğŸŒ¤ï¸ æŠ“å–å³æ™‚å¤©æ°£çš„å‡½æ•¸
        async function getRealTimeWeather(locationName) {
            const weatherEl = document.getElementById('weather-temp');
            const iconEl = document.getElementById('weather-icon');
            
            // å…ˆé¡¯ç¤ºè®€å–ä¸­
            weatherEl.innerText = "åµæ¸¬ä¸­...";
            
            // æŸ¥æ‰¾åº§æ¨™
            const coords = cityCoordinates[locationName] || cityCoordinates["default"];
            
            try {
                // ä½¿ç”¨ Open-Meteo API (å…è²»ï¼Œç„¡éœ€ Key)
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true`);
                const data = await response.json();
                
                const temp = Math.round(data.current_weather.temperature);
                const code = data.current_weather.weathercode;
                
                // æ›´æ–°ä»‹é¢
                weatherEl.innerText = `${temp}Â°C ç¾åœ°`;
                
                // ç°¡å–®çš„å¤©æ°£ä»£ç¢¼å°æ‡‰åœ–ç¤º
                if (code <= 3) { iconEl.className = "fas fa-sun mr-2 text-[#C5A059]"; } // æ™´
                else if (code <= 48) { iconEl.className = "fas fa-cloud mr-2 text-gray-400"; } // é›²
                else if (code <= 67) { iconEl.className = "fas fa-umbrella mr-2 text-blue-400"; } // é›¨
                else { iconEl.className = "fas fa-snowflake mr-2 text-white"; } // é›ª/å…¶ä»–

            } catch (error) {
                console.error("Weather fetch failed", error);
                // å¤±æ•—æ™‚é¡¯ç¤º CSV è£¡çš„å‚™ç”¨å¤©æ°£
                weatherEl.innerText = "æ°£è±¡é€£ç·šå¤±æ•—";
            }
        }

        function loadDay(dayKey) {
            window.scrollTo(0, 0);

            document.querySelectorAll('#day-scroller button').forEach(btn => {
                btn.className = 'w-12 h-12 flex flex-col items-center justify-center border-2 border-[#C5A059]/30 bg-[#0D0F22] text-[#C5A059]/50 transition-all transform rotate-45';
            });
            const activeBtn = document.getElementById(`day-btn-${dayKey}`);
            if(activeBtn) {
                activeBtn.className = 'w-12 h-12 flex flex-col items-center justify-center border-2 border-[#C5A059] bg-[#C5A059] text-[#181B39] shadow-[0_0_15px_#C5A059] transition-all transform scale-110 rotate-45';
            }

            const dayData = globalItinerary.find(d => d.day == dayKey);
            if(!dayData) return;

            document.getElementById('current-date').innerText = dayData.date;
            document.getElementById('current-location').innerText = dayData.location;
            document.getElementById('day-display').innerText = dayData.day;
            
            // ğŸš€ å‘¼å«å³æ™‚å¤©æ°£åŠŸèƒ½ (å–ä»£åŸæœ¬è®€å– CSV weather çš„å‹•ä½œ)
            // åŸæœ¬æ˜¯: document.getElementById('weather-temp').innerText = dayData.weather;
            getRealTimeWeather(dayData.location);

            const container = document.getElementById('timeline-container');
            container.innerHTML = dayData.events.map((event, index) => {
                let sideColor = "bg-[#181B39]";
                let tagText = "ä¸€èˆ¬";
                let borderColor = "border-[#C5A059]";

                if(event.type === 'must-go') { sideColor = "bg-[#9E2A2B]"; tagText = "æœ¬é™£"; borderColor = "border-[#9E2A2B]"; } 
                else if(event.type === 'transport') { sideColor = "bg-[#2E5077]"; tagText = "è¡Œè»"; } 
                else if(event.type === 'food') { sideColor = "bg-[#D46C00]"; tagText = "å…µç³§"; } 
                else if(event.type === 'hotel') { sideColor = "bg-[#4A3B52]"; tagText = "å®¿ç‡Ÿ"; }

                return `
                <div class="flex w-full mb-4 fade-in-up group" style="animation-delay: ${index * 100}ms">
                    <div class="w-[50px] flex-shrink-0 text-right pr-4 pt-4">
                        <div class="font-sengoku text-lg text-[#C5A059] leading-none">${event.time.split(':')[0]}<span class="text-xs align-top opacity-60 font-sans">:${event.time.split(':')[1]}</span></div>
                    </div>
                    <div class="w-[16px] relative flex-shrink-0 flex justify-center">
                        <div class="timeline-line"></div>
                        <div class="w-3 h-3 ${sideColor} rotate-45 mt-5 relative z-10 border border-[#F4F1EA] group-hover:scale-125 transition-transform shadow shadow-black/50"></div>
                    </div>
                    <div class="flex-1 pl-4 min-w-0">
                        <div class="sengoku-card relative p-3 transition-all active:scale-[0.98] cursor-pointer" 
                             style="border-left-color: ${event.type === 'must-go' ? '#9E2A2B' : '#C5A059'}"
                             onclick="openModal('${event.title}', '${event.desc}', '${event.tip || ''}', '${event.location}')">
                            <div class="flex justify-between items-start mb-1">
                                <span class="tag-wood">${tagText}</span>
                                <i class="fas fa-chevron-right text-[#C5A059]/50 text-xs mt-1"></i>
                            </div>
                            <h3 class="font-bold text-lg text-[#181B39] mb-1 font-sengoku tracking-wide">${event.title}</h3>
                            <p class="text-[#5A4A3A] text-sm line-clamp-2 leading-relaxed font-medium">${event.desc}</p>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function openModal(title, desc, tip, location) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            const tipBox = document.getElementById('modal-tip-box');
            if(tip) { tipBox.style.display = 'block'; document.getElementById('modal-tip').innerText = tip; } 
            else { tipBox.style.display = 'none'; }
            document.getElementById('modal-action-btn').onclick = () => window.open(`https://www.google.com/maps/search/?api=1&query=${location}`, '_blank');
            document.getElementById('info-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('info-modal').classList.add('hidden'); }
    </script>
</body>
</html>